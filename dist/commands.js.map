{"version":3,"sources":["../src/commands.js"],"names":[],"mappings":"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","file":"commands.js","sourcesContent":["// commands file\n\nimport crypto from 'crypto';\nimport { Promise } from 'bluebird';\nimport moment from 'moment-timezone';\nimport { habitApi } from './habit.js';\nimport { has, get } from 'lodash/object';\nimport * as alerts from './alerts';\n\n\nmoment.tz.setDefault(\"America/New_York\");\n\nconst help_text = {\n\n\t\"default\": \n`I am a helper bot for your Habitica party! Here is my current list of commands:\n\t- say <message>: say something in your channel\n\t- list: get the current list of party members\n\t- stats <stat>: get the current value of <stat> for each party member. Type 'help stats' for more info.\n\t- chat <limit>: get the last <limit> chat messages for the party.\n\t- partyData <path>: retrieve the raw group object and output the value at <path> [volatile]\nIf you have any questions, concerns, or praise, heap it upon lilactown. Thanks!`,\n\n\t\"stats\":\n`Example: @habitbot: stats hp\n\tAvailable stats are: per, int, con, str, points, class, lvl, gp, exp, mp, hp`,\n\n\t\"chat\":\n`Example: @habitbot: chat 50\n\tReturns the last N (i.e. 50) chat messages from the party chat`\n};\n\nfunction sendToChannel(channel) {\n\treturn function (text) {\n\t\tchannel.send(text);\n\t\tconsole.log(`[#${channel.name}] > ${text}`);\n\t};\n}\n\nfunction statBelow(stat, threshold) {\n\treturn () => habitApi\n\t\t.getPartyMembersInfo()\n\t\t.then((members) => members.filter((member) => member.stats[stat] < threshold))\n\t\t.then((members) => {\n\t\t\tconst names = members.map((member) => member.profile.name).join(', ');\n\t\t\treturn members.length ? `${stat} alert: ${names} ${members.length > 1 ? 'are' : 'is'} in danger (<${threshold})!` : `${stat} alert: Everyone is fine (>${threshold})! (for now)`;\n\t\t});\n}\n\nconst commands = {\n\thello(channel, user) {\n\t\tconst message = `Hello, ${user.name}! My name is habitbot. Type \"@habitbot: help\" for more info.`;\n\t\tsendToChannel(channel)(message);\n\t},\n\thelp(channel, user, command) {\n\t\tif(has(help_text,command)) {\n\t\t\tsendToChannel(channel)(help_text[command]);\n\t\t} else {\n\t\t\tsendToChannel(channel)(help_text.default);\n\t\t}\n\t},\n\tsay(channel, user, ...parts) {\n\t\tconst message = parts.join(\" \");\n\t\tsendToChannel(channel)(message);\n\t},\n\tpartyData(channel, user, path) {\n\t\tconst send = sendToChannel(channel);\n\t\tconst getPath = (json) => {\n\t\t\tif (has(json, path)) {\n\t\t\t\tconsole.log(get(json, path));\n\t\t\t\treturn get(json, path);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn \"Value is undefined.\";\n\t\t\t}\n\t\t};\n\n\t\tconst sendValue = (value) => send(JSON.stringify(value));\n\n\t\thabitApi\n\t\t\t.getParty()\n\t\t\t.then(getPath)\n\t\t\t.then(sendValue)\n\t\t\t.catch((err) => console.error(err));\n\t},\n\tflip(channel, user, a, b) {\n\t\tconst send = sendToChannel(channel);\n\t\tsend((crypto.randomBytes(1)[0]<127) ? a : b);\n\t},\n\tchat(channel,user,limit=10) {\n\t\tconst send = sendToChannel(channel);\n\t\tconst _chat = {\n\t\t\t\"text\": `Last ${limit} party chat messages:`,\n\t\t\t\"as_user\": true,\n\t\t\t\"token\": channel._client.token\n\t\t};\n\n\t\tif(limit>20) {\n\t\t\tlimit = 20;\n\t\t}\n\n\t\thabitApi\n\t\t\t.getParty()\n\t\t\t.then((json) => json.chat.slice(0,limit))\n\t\t\t.then((chats) => chats.map((chat) => { \n\t\t\t\t\tconsole.log(chat.timestamp);\n\t\t\t\t\treturn {\n\t\t\t\t\t\t\"text\": `(${moment(chat.timestamp).calendar()}) *${chat.user || 'habitica'}*: ${chat.text}`,\n\t\t\t\t\t\t\"color\": (!chat.user) ? (/attacks party for [^0]/i.test(chat.text) ? \"danger\" : \"good\") : \"#439FE0\",\n\t\t\t\t\t\t\"mrkdwn_in\": [\"text\"]\n\t\t\t\t\t};\n\t\t\t\t})\n\t\t\t)\n\t\t\t.then((atts) => { \n\t\t\t\t_chat.attachments = atts.reverse();\n\t\t\t\treturn channel.postMessage(_chat);\n\t\t\t})\n\t\t\t.catch((err) => console.error(err));\n\t},\n\tlist(channel, user) {\n\t\tconst send = sendToChannel(channel);\n\t\thabitApi\n\t\t\t.getParty()\n\t\t\t.then((json) => json.members.map((member) => member.profile.name).join(', '))\n\t\t\t.then(send)\n\t\t\t.catch((err) => console.error(err));\n\t},\n\tstats(channel, user, stat) {\n\t\tconst send = sendToChannel(channel);\n\t\thabitApi\n\t\t\t.getPartyMembersInfo()\n\t\t\t.then((members) => members.map((member) => `${member.profile.name}: ${typeof member.stats[stat] === 'number' ? Math.round(member.stats[stat]) : member.stats[stat]} ${stat}`).join('\\n'))\n\t\t\t.then(send)\n\t\t\t.catch((err) => console.error(err));\n\t},\n\talerts(channel, user, command, stat, threshold) {\n\t\tconst send = sendToChannel(channel);\n\t\tif (command === 'register') {\n\t\t\talerts.register(statBelow(stat, threshold));\n\t\t\tsend(`Alert registered: member ${stat} falls below ${threshold}`)\n\t\t}\n\t\telse {\n\t\t\talerts.runEach(send);\n\t\t}\n\t}\n};\n\nmodule.exports = commands;\n"]}